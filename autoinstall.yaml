autoinstall:
  version: 1
  
  # Basic system configuration
  locale: en_US.UTF-8
  keyboard:
    layout: us
  
  # Network configuration
  network:
    network:
      version: 2
      ethernets:
        eth0:
          dhcp4: true
  
  # Storage configuration - simple single disk setup
  storage:
    layout:
      name: lvm
  
  # User configuration
  identity:
    hostname: AI-BOB
    username: matt
    password: $6$RqYP2lhZc7gqtSqF$jNkh4gpFK8Hpqnf4TiQHHiT3zWOF6Gx4fnzyFUh2A.0yCw1OhLXL4.5iWME4qSqYCP8Eab/tsPNelABgXrlbe1  
    realname: System User
  
  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true
  
  # Package configuration
  apt:
    primary:
      - arches: [amd64, i386]
        uri: http://archive.ubuntu.com/ubuntu
    security:
      - arches: [amd64, i386]
        uri: http://security.ubuntu.com/ubuntu
    sources:
      # Graphics drivers PPA
      graphics-drivers:
        source: 'ppa:graphics-drivers/ppa'
        keyid: 'FCAE110B1118213C'
  
  # Package selection
  packages:
    # Basic system packages
    - ubuntu-desktop-minimal
    - curl
    - wget
    - git
    - build-essential
    - dkms
    - linux-headers-generic
    
    # NVIDIA packages
    - nvidia-driver-560  # Latest available driver
    - nvidia-dkms-560
    - nvidia-utils-560
    - nvidia-settings
    - nvidia-prime
    
    # VS Code
    # Will be installed via late-commands with proper key setup
    
    # Additional useful packages
    - firefox
    - vim
    - htop
    - tree
    - unzip
    - software-properties-common
    - apt-transport-https
    - ca-certificates
    - gnupg
    - lsb-release
  
  # Late commands to run after installation
  late-commands:
    # Add Microsoft GPG key and repository for VS Code
    - curtin in-target --target=/target -- wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/keyrings/packages.microsoft.gpg
    - curtin in-target --target=/target -- sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
    
    # Update package lists
    - curtin in-target --target=/target -- apt update
    
    # Install VS Code
    - curtin in-target --target=/target -- apt install -y code
    
    # Install latest NVIDIA driver (in case newer version is available)
    - curtin in-target --target=/target -- ubuntu-drivers autoinstall
    
    # Enable NVIDIA persistence daemon
    - curtin in-target --target=/target -- systemctl enable nvidia-persistenced
    
    # Configure NVIDIA settings
    - curtin in-target --target=/target -- nvidia-xconfig
    
    # Install additional VS Code extensions (optional)
    - curtin in-target --target=/target -- sudo -u user code --install-extension ms-python.python --user-data-dir=/home/user/.vscode
    - curtin in-target --target=/target -- sudo -u user code --install-extension ms-vscode.cpptools --user-data-dir=/home/user/.vscode
    
    # Set up NVIDIA environment variables
    - curtin in-target --target=/target -- echo 'export PATH=/usr/local/cuda/bin:$PATH' >> /home/user/.bashrc
    - curtin in-target --target=/target -- echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> /home/user/.bashrc
    
    # Final system update
    - curtin in-target --target=/target -- apt upgrade -y
    
    # Clean up
    - curtin in-target --target=/target -- apt autoremove -y
    - curtin in-target --target=/target -- apt autoclean
  
  # Automatic reboot after installation
  shutdown: reboot
